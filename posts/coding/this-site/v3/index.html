<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="color-scheme" content="dark light" /><meta name="description" content="After getting nagged with 6 dependabot security vulnerabilities (which weren't actually vulnerabilities) I figured it was finally time to dust off thi…" /><title>How this Site will Always be Built</title><link rel="stylesheet" type="text/css" href="/main-e9128.css" /><link rel="shortcut icon" href="/favicon.png" /><link rel="manifest" href="/manifest.webmanifest" /><link rel="alternate" type="application/rss+xml" title="The Smart Blog • Feed" href="/feed" /><meta name="theme-color" content="#00D1B2" /></head><body><header><nav class="breadcrumb is-marginless is-centered" aria-label="breadcrumbs"><ul><li class><a href="/">Home</a></li><li class><a href="/posts">Posts</a></li><li class><a href="/posts/coding">Coding</a></li><li class><a href="/posts/coding/this-site">This Site</a></li><li class="is-active"><span>V3</span></li></ul></nav></header><div class="page-content"><div class="section titles-section"><h1 class="title is-2">How this Site will Always be Built</h1><span class="time-to-read"><time dateTime="2021-05-12">May 12, 2021</time> · 2 min read</span></div><main><div id="content" class="content"><p>After getting nagged with <a href="https://github.com/thesmartwon/thesmartwon.com/pulls?q=is%3Apr+author%3Aapp%2Fdependabot">6 dependabot security vulnerabilities</a> (which weren't actually vulnerabilities) I figured it was finally time to dust off this site and give it some love. </p><h2 id="what-i-really-really-want">What I really really want</h2><ul><li>Write blog posts in MD which are rendered to HTML<ul><li>Allow importing some JSX</li><li>Allow writing some JS for interactive pages (like the <a href="/posts/money/early-retirement">retirement calculator</a>)</li></ul></li></ul><p>As an example, I might want to write:</p><pre><code class="language-md">import { RetirementCalc } from './retirement-calc'

Brilliant, you'd like to quit
your day job and do something
more meaningful with your life.
Now how do you do it?

&lt;RetirementCalc /&gt;</code></pre><ul><li>Write blog components in JSX<ul><li>I still want to keep writing code like <code>{posts.map(post =&gt; ArticlePreview(post))}</code> for index pages!</li></ul></li></ul><h3 id="whats-wrong-with-v2">What's wrong with v2?</h3><p>v2 of this site had <a href="https://github.com/thesmartwon/thesmartwon.com/blob/9b3ec7e047366a79a12a1d94776d967677e2ada3/package.json">too many dependencies</a> and relied on <a href="https://babeljs.io/docs/en/babel-register"><code>@babel/register</code></a> for transpiling JSX for server-side-rendering. This was slow and error-prone when writing a development server. With <a href="https://esbuild.github.io/">esbuild</a> being the fastest transpiler and bundler in town (and sporting no dependencies!) I had to give it a try.</p><h2 id="the-perfect-system">The perfect system</h2><figure><img src="perfect-system.jpg" alt="Clu asking to create perfect system" /><figcaption>Am I still to create the perfect system? [Tron]</figcaption></figure><p>I decided the perfect blog build system has just 3 tasks:</p><ul><li>build<ul><li>Clean (just <code>rm -rf dist</code>)</li><li>Copy static and post assets</li><li>Transpile MD to JSX</li><li>Render JSX to HTML</li></ul></li><li>start<ul><li>Build</li><li>Serve <code>dist</code> under <a href="http://localhost">http://localhost</a></li><li>Watch for changes</li></ul></li><li>serve<ul><li>Serve <code>dist</code> under <a href="http://localhost">http://localhost</a> exactly like production</li></ul></li></ul><h3 id="build">Build</h3><h4 id="transforming-md-to-jsx">Transforming MD to JSX</h4><p>The old v2 system was based on <code>unified</code> and <code>@babel/register</code> but:</p><ol><li>I really don't need all their features, I just need frontmatter and <code>import</code> statement support</li><li>Both have rather large dependency trees</li></ol><p>Enter <a href="https://marked.js.org/"><code>marked</code></a>, a JS library with no dependencies and exactly the functionality I need. 10 years of battle-testing has yielded a non-fussy library where the user doesn't have to parse ASTs! After 100 lines of config (mostly manipulating strings) I was able to transform my MD posts to JSX!</p><p>I also took the time to hook up <code>esbuild</code> to bundle JS if there's a matching <code>.js</code> file to the <code>.md</code> file.</p><h4 id="transforming-jsx-to-html">Transforming JSX to HTML</h4><p>The old v2 system had some <code>const index = {}</code> variables in memory which were exported and then loaded wherever needed (so import order was important)!</p><figure><pre><code class="language-js">let postIndex = {}
module.exports = { postIndex }</code></pre><figcaption>Many index, much <a href="https://github.com/thesmartwon/thesmartwon.com/blob/9b3ec7e047366a79a12a1d94776d967677e2ada3/scripts/gulp/posts.js">bad old code</a></figcaption></figure><p>Instead of having indexes live in memory in source files I complemented the new JSX system by writing a <code>src/generated/index.js</code> file with a listing of all pages and posts. As long as this file can be imported by both a JS bundler (for SSR) and by Node (to iterate through every page) I wouldn't need <code>@babel/register</code> anymore!</p><figure><pre><code class="language-js">const index = require('../../../src/generated')
Object.entries(index).forEach(renderPage)</code></pre><figcaption>A sane way to do SSR.</figcaption></figure><h4 id="css">CSS</h4><p>The old v2 system used <a href="https://www.npmjs.com/package/node-sass">node-sass</a>, but they had platform-dependent (and often incompatible) binaries and 16 dependencies. I still needed a SASS compiler since I'm using <code>bulma</code>, but I opted for <a href="https://www.npmjs.com/package/sass">dart-sass</a> with its single <code>chokidar</code> dependency instead.</p><h3 id="start">Start</h3><p>My site builds in around 1s, so the start task really just needs to rereun the correct build tasks and provide a live-reload server.</p><figure><pre><code class="language-sh">npm run build  1.23s user 0.17s system 139% cpu 0.997 total</code></pre><figcaption>Now this is actually &quot;blazingly fast&quot;. It also scales linearly instead of exponentially (looking at you, Gatsby).</figcaption></figure><h4 id="watching-for-changes">Watching for changes</h4><p>Since <a href="https://www.npmjs.com/package/chokidar"><code>chokidar</code></a> came along with <code>dart-sass</code> I can use it to watch the correct source files:</p><pre><code class="language-js">function register(path, listener) {
  chokidar.watch(path, { ignoreInitial: true }).on('all', listener)
}
// TODO: use CSS instead of SASS
register('src/**/*.sass', css)
// TODO: copy only what changes
register('posts/**/*.{jpg,jpeg,gif,svg,png}', copy)
// Need to rewrite index to update nav
register('posts/**/*.md', (ev, file) =&gt; {
  console.log('[watch]', ev, file)
  if (ev === 'change' || ev === 'add') {
    post(file)
  }
  else if (ev === 'unlink') {
    delete index[slugify(file)]
  }
  writeIndex()
})</code></pre><h3 id="serving-with-live-reloading">Serving with live-reloading</h3><p>The old v2 system used <a href="https://www.npmjs.com/package/browser-sync">browser-sync</a> which weighs in with 30 direct dependencies! Instead, I decided to write my own HTTP server to both:</p><ol><li>Serve assets like Github pages's NGINX would in production</li><li>Inject a livereload script for development</li></ol><p>It turned out to only take <a href="https://github.com/thesmartwon/thesmartwon.com/blob/master/scripts/serve.js">100 lines of vanilla Node14 code!</a> By tracking connected clients in my HTTP server I could add this to my <code>start</code> script to get live-reloading:</p><pre><code class="language-js">const { clients } = require('./serve')

// Index pages now update when I touch site components!
esbuild.build({
  ...esbuildConfigSSR,
  watch: {
    onRebuild(error) {
      if (error) {
        console.log(error)
        return
      }
      // TODO: render only changed post + pages
      render({ cssFileNames })
      clients.forEach(res =&gt; res.write('data: update'))
      clients.length = 0
    },
  },
})</code></pre><h2 id="summary">Summary</h2><p>Using fewer tools has led to a faster more maintainable build system with fewer dependencies that Github's dependabot shouldn't ever bother me about.</p><p>Some future areas for improvement (which are no longer daunting!)</p><ul><li>Add back RSS</li><li>Ditch SASS for my own CSS (I want a dark mode!)</li><li>Create image pipeline (resizing and container size)</li><li>Improve watcher to only rerender changed files</li><li>Wrap build system in another package for others to use!</li></ul></div></main></div><footer><a href="#">Back to top</a> / <a href="/posts/">View all posts</a></footer></body></html>